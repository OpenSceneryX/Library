#tag WindowBegin Window wndMain   BackColor       =   16777215   Backdrop        =   ""   BalloonHelp     =   ""   CloseButton     =   "True"   Composite       =   "False"   Frame           =   0   FullScreen      =   "False"   HasBackColor    =   "False"   Height          =   482   ImplicitInstance=   "True"   LiveResize      =   "True"   MacProcID       =   0   MaxHeight       =   32000   MaximizeButton  =   "False"   MaxWidth        =   32000   MenuBar         =   341440760   MenuBarVisible  =   "True"   MinHeight       =   482   MinimizeButton  =   "True"   MinWidth        =   453   Placement       =   0   Resizeable      =   "True"   Title           =   "OpenSceneryX Installer"   Visible         =   "True"   Width           =   453   Begin Canvas Canvas1      AcceptFocus     =   ""      AcceptTabs      =   ""      AutoDeactivate  =   "True"      Backdrop        =   200112520      ControlOrder    =   0      Enabled         =   True      EraseBackground =   "True"      Height          =   52      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Left            =   20      LockBottom      =   ""      LockLeft        =   ""      LockRight       =   ""      LockTop         =   ""      Scope           =   0      TabPanelIndex   =   0      Top             =   14      UseFocusRing    =   "True"      Visible         =   True      Width           =   236      BehaviorIndex   =   0   End   Begin Thread thrBuildAndCheckManifests      ControlOrder    =   1      Index           =   -2147483648      InitialParent   =   ""      Left            =   20      Priority        =   4      Scope           =   0      StackSize       =   0      TabPanelIndex   =   0      Top             =   -65      BehaviorIndex   =   1   End   Begin PushButton btnSaveManifest      AutoDeactivate  =   "True"      Bold            =   ""      Cancel          =   ""      Caption         =   "Save Manifest"      ControlOrder    =   2      Default         =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   503      LockBottom      =   ""      LockLeft        =   ""      LockRight       =   ""      LockTop         =   ""      Scope           =   0      TabPanelIndex   =   0      TextFont        =   "System"      TextSize        =   0      Top             =   -53      Underline       =   ""      Visible         =   True      Width           =   108      BehaviorIndex   =   2   End   Begin HTTPSocket sockManifest      Address         =   ""      ControlOrder    =   3      Index           =   -2147483648      InitialParent   =   ""      Left            =   374      Port            =   80      Scope           =   0      TabPanelIndex   =   0      Top             =   -65      yield           =   0      BehaviorIndex   =   3   End   Begin Thread thrCheckFolderStructure      ControlOrder    =   4      Index           =   -2147483648      InitialParent   =   ""      Left            =   62      Priority        =   4      Scope           =   0      StackSize       =   0      TabPanelIndex   =   0      Top             =   -65      BehaviorIndex   =   4   End   Begin EditField fldMessage      AcceptTabs      =   ""      Alignment       =   0      AutoDeactivate  =   "True"      BackColor       =   &hFFFFFF      Bold            =   ""      Border          =   "True"      ControlOrder    =   5      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Format          =   ""      Height          =   320      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   20      LimitText       =   0      LockBottom      =   "True"      LockLeft        =   "True"      LockRight       =   "True"      LockTop         =   "True"      Mask            =   ""      Multiline       =   "True"      Password        =   ""      ReadOnly        =   "True"      Scope           =   0      ScrollbarHorizontal=   ""      ScrollbarVertical=   "True"      Styled          =   ""      TabPanelIndex   =   0      Text            =   ""      TextColor       =   &h000000      TextFont        =   "System"      TextSize        =   10      Top             =   110      Underline       =   ""      UseFocusRing    =   "True"      Visible         =   True      Width           =   413      BehaviorIndex   =   5   End   Begin ProgressBar prgBar      AutoDeactivate  =   "True"      ControlOrder    =   6      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Left            =   108      LockBottom      =   "True"      LockLeft        =   "True"      LockRight       =   "True"      LockTop         =   "False"      Maximum         =   100      Scope           =   0      TabPanelIndex   =   0      Top             =   442      Value           =   0      Visible         =   "False"      Width           =   325      BehaviorIndex   =   6   End   Begin HTTPSocket sockFile      Address         =   ""      ControlOrder    =   7      Index           =   -2147483648      InitialParent   =   ""      Left            =   413      Port            =   80      Scope           =   0      TabPanelIndex   =   0      Top             =   -65      yield           =   0      BehaviorIndex   =   7   End   Begin StaticText StaticText1      AutoDeactivate  =   "True"      Bold            =   "True"      ControlOrder    =   8      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   20      LockBottom      =   ""      LockLeft        =   ""      LockRight       =   ""      LockTop         =   ""      Multiline       =   ""      Scope           =   0      TabPanelIndex   =   0      Text            =   "#kXPlaneFolder"      TextAlign       =   0      TextColor       =   &h000000      TextFont        =   "System"      TextSize        =   10      Top             =   78      Underline       =   ""      Visible         =   True      Width           =   111      BehaviorIndex   =   8   End   Begin StaticText txtXplaneFolder      AutoDeactivate  =   "True"      Bold            =   ""      ControlOrder    =   9      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   143      LockBottom      =   ""      LockLeft        =   "True"      LockRight       =   "True"      LockTop         =   ""      Multiline       =   ""      Scope           =   0      TabPanelIndex   =   0      Text            =   "Untitled"      TextAlign       =   0      TextColor       =   &h000000      TextFont        =   "System"      TextSize        =   10      Top             =   78      Underline       =   ""      Visible         =   True      Width           =   243      BehaviorIndex   =   9   End   Begin PushButton btnSetXPlaneFolder      AutoDeactivate  =   "True"      Bold            =   ""      Cancel          =   ""      Caption         =   "#kSet"      ControlOrder    =   10      Default         =   ""      Enabled         =   "False"      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   386      LockBottom      =   ""      LockLeft        =   ""      LockRight       =   "True"      LockTop         =   ""      Scope           =   0      TabPanelIndex   =   0      TextFont        =   "System"      TextSize        =   10      Top             =   77      Underline       =   ""      Visible         =   True      Width           =   47      BehaviorIndex   =   10   End   Begin PushButton btnBegin      AutoDeactivate  =   "True"      Bold            =   ""      Cancel          =   ""      Caption         =   "#kGo"      ControlOrder    =   11      Default         =   ""      Enabled         =   "False"      Height          =   51      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   353      LockBottom      =   ""      LockLeft        =   ""      LockRight       =   "True"      LockTop         =   ""      Scope           =   0      TabPanelIndex   =   0      TextFont        =   "System"      TextSize        =   0      Top             =   14      Underline       =   ""      Visible         =   True      Width           =   80      BehaviorIndex   =   11   End   Begin Thread thrUpdateFolderStructure      ControlOrder    =   12      Index           =   -2147483648      InitialParent   =   ""      Left            =   106      Priority        =   4      Scope           =   0      StackSize       =   0      TabPanelIndex   =   0      Top             =   -65      BehaviorIndex   =   12   End   Begin StaticText txtProgress      AutoDeactivate  =   "True"      Bold            =   ""      ControlOrder    =   13      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   20      LockBottom      =   "True"      LockLeft        =   "True"      LockRight       =   ""      LockTop         =   ""      Multiline       =   ""      Scope           =   0      TabPanelIndex   =   0      Text            =   "Untitled"      TextAlign       =   0      TextColor       =   &h000000      TextFont        =   "System"      TextSize        =   10      Top             =   442      Underline       =   ""      Visible         =   True      Width           =   74      BehaviorIndex   =   13   EndEnd#tag EndWindow#tag WindowCode	#tag Event		Sub Open()		  setupOSXFolder()		  displayXPlaneFolder()		  checkOSXFolder()		End Sub	#tag EndEvent	#tag Method, Flags = &h0		Sub downloadNextFile()		  if (pPendingFiles.Count > 0) then		    dim filePath as String = normaliseFilePath(pPendingFiles.item(1))		    dim destinationFolderItem as FolderItem = getTemporaryFolderItem()		    msgBox(destinationFolderItem.absolutePath())		    dim i as Integer		    dim parts() as String = filePath.split("/")		    		    txtProgress.visible = true		    txtProgress.text = App.processParameterizedString(kFilesRemain, Array(str(pPendingFiles.count)))		    showMessage(filePath)		    		    dim url as string = App.kRepositoryURL + "/repository"		    		    for i = 0 to ubound(parts)		      if (parts(i) <> "") then url = url + "/"		      url = url + encodeURLComponent(parts(i))		    next		    		    url = url + ".zip"		    		    sockFile.get(url, destinationFolderItem)		  else		    showMessage(kInstallComplete)		    prgBar.visible = false		    txtProgress.visible = false		    btnSetXPlaneFolder.enabled = true		  end if		  		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub showMessage(message as String, optional parameters() as String)		  message = App.processParameterizedString(message, parameters)		  fldMessage.appendText(message + endOfLine)		  fldMessage.scrollPosition = 10000000		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub setupOSXFolder()		  dim foundPrevious as boolean = false		  dim tempFolderItem as FolderItem		  		  // Newest name takes top priority, followed by older releases		  pOsxFolderItem = App.pXPlaneFolder.child("Custom Scenery").child("OpenSceneryX")		  if (pOsxFolderItem.exists()) then		    foundPrevious = true		  end if		  		  tempFolderItem = App.pXPlaneFolder.child("Custom Scenery").child("OpenSceneryX-1.1.0")		  if (tempFolderItem.exists) then		    if (foundPrevious) then		      Utilities.deleteContentsOfFolder(tempFolderItem)		      tempFolderItem.delete()		    else		      tempFolderItem.moveFileTo(pOsxFolderItem)		      foundPrevious = true		    end if		  end if		  		  tempFolderItem = App.pXPlaneFolder.child("Custom Scenery").child("OpenSceneryX-1.0.0")		  if (tempFolderItem.exists) then		    if (foundPrevious) then		      Utilities.deleteContentsOfFolder(tempFolderItem)		      tempFolderItem.delete()		    else		      tempFolderItem.moveFileTo(pOsxFolderItem)		      foundPrevious = true		    end if		  end if		  		  if (not foundPrevious) then		    pOsxFolderItem.createAsFolder()		  end if		  		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub displayXPlaneFolder()		  txtXplaneFolder.text = App.pXPlaneFolder.absolutePath		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub checkOSXFolder()		  pLocalManifest = new FolderManifest()		  pServerManifest = new FolderManifest()		  		  thrBuildAndCheckManifests.run()		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub preProcessLocalFolderItem(osxFolderItem as FolderItem)		  // Fix any one-off issues here, usually caused by case changes		  		  // Problem with b767-300ER changing to b767-300er		  		  dim b767FolderItem as FolderItem = osxFolderItem.child("objects").child("aircraft").child("jets").child("heavy").child("b767-300ER")		  if (b767FolderItem.exists()) then		    b767FolderItem.name = "b767-300er"		  end if		  		Exception err as NilObjectException		  // Catch this in case any folder item doesn't exist (new install)		End Sub	#tag EndMethod	#tag Property, Flags = &h0		pOsxFolderItem As FolderItem	#tag EndProperty	#tag Property, Flags = &h0		pLocalManifest As FolderManifest	#tag EndProperty	#tag Property, Flags = &h0		pServerManifest As FolderManifest	#tag EndProperty	#tag Property, Flags = &h0		pPendingFiles As Collection	#tag EndProperty	#tag Property, Flags = &h0		pDeletedFiles As Collection	#tag EndProperty	#tag Constant, Name = kGo, Type = String, Dynamic = True, Default = \"Go", Scope = Public	#tag EndConstant	#tag Constant, Name = kSet, Type = String, Dynamic = True, Default = \"Set\xE2\x80\xA6", Scope = Public	#tag EndConstant	#tag Constant, Name = kXPlaneFolder, Type = String, Dynamic = True, Default = \"X-Plane\xC2\xAE Folder:", Scope = Public	#tag EndConstant	#tag Constant, Name = kError, Type = String, Dynamic = True, Default = \"Error: \"${1}\"", Scope = Public	#tag EndConstant	#tag Constant, Name = kExtractionFailed, Type = String, Dynamic = True, Default = \"Extraction of \"${1}\" failed: \"${2}\"", Scope = Public	#tag EndConstant	#tag Constant, Name = kErrorHTTP, Type = String, Dynamic = True, Default = \"There was an error downloading the file (status ${1})\x2C the download was aborted.", Scope = Public	#tag EndConstant	#tag Constant, Name = kErrorDownloading, Type = String, Dynamic = True, Default = \"Error downloading (code ${1})\x2C retrying\xE2\x80\xA6", Scope = Public	#tag EndConstant	#tag Constant, Name = kManifestDownloaded, Type = String, Dynamic = True, Default = \"The download of the list of files is complete.", Scope = Public	#tag EndConstant	#tag Constant, Name = kErrorManifest, Type = String, Dynamic = True, Default = \"There was a problem with the list of files downloaded from the server\x2C please try again later.", Scope = Public	#tag EndConstant	#tag Constant, Name = kCollectingLocalFileInformation, Type = String, Dynamic = True, Default = \"Collecting local file information\xE2\x80\xA6", Scope = Public	#tag EndConstant	#tag Constant, Name = kComplete, Type = String, Dynamic = True, Default = \"Complete.", Scope = Public	#tag EndConstant	#tag Constant, Name = kDownloadingManifest, Type = String, Dynamic = True, Default = \"Connecting to the server and loading the list of available files\x2C please wait\xE2\x80\xA6", Scope = Public	#tag EndConstant	#tag Constant, Name = kErrorDownloadingManifest, Type = String, Dynamic = True, Default = \"There was an error while fetching the list of files - attempt ${1}.", Scope = Public	#tag EndConstant	#tag Constant, Name = kGivingUp, Type = String, Dynamic = True, Default = \"Giving up.", Scope = Public	#tag EndConstant	#tag Constant, Name = kInstallUpToDate, Type = String, Dynamic = True, Default = \"Your OpenSceneryX install is completely up to date\x2C you may now quit this installer.", Scope = Public	#tag EndConstant	#tag Constant, Name = kInstallOutOfDate, Type = String, Dynamic = True, Default = \"Your OpenSceneryX install is out of date\x2C ${1} files need to be deleted and ${2} files need to be downloaded\x2C press the \'Go\' button to begin the process.", Scope = Public	#tag EndConstant	#tag Constant, Name = kSeparator, Type = String, Dynamic = False, Default = \"----", Scope = Public	#tag EndConstant	#tag Constant, Name = kDeletingFiles, Type = String, Dynamic = True, Default = \"Deleting Files:", Scope = Public	#tag EndConstant	#tag Constant, Name = kDownloadingChangedFiles, Type = String, Dynamic = True, Default = \"Downloading Changed Files:", Scope = Public	#tag EndConstant	#tag Constant, Name = kInstallComplete, Type = String, Dynamic = True, Default = \"Your OpenSceneryX installation is now Complete.", Scope = Public	#tag EndConstant	#tag Constant, Name = kFilesRemain, Type = String, Dynamic = True, Default = \"${1} remain", Scope = Public	#tag EndConstant#tag EndWindowCode#tag Events thrBuildAndCheckManifests	#tag Event		Sub Run()		  prgBar.visible = true		  prgBar.maximum = 0		  txtProgress.visible = false		  		  showMessage(kCollectingLocalFileInformation)		  preProcessLocalFolderItem(pOsxFolderItem)		  pLocalManifest.gatherManifestFromLocalFolderItem(pOsxFolderItem)		  showMessage(kComplete)		  showMessage(kSeparator)		  		  showMessage(kDownloadingManifest)		  sockManifest.Get(App.kRepositoryURL + "/manifest.xml")		  		  dim tries as integer = 0		  		  do		    while (sockManifest.isConnected and sockManifest.lastErrorCode = sockManifest.NoError)		      // Wait half a second		      me.sleep(500)		    wend		    		    if (sockManifest.lastErrorCode <> sockManifest.NoError) then		      // Socket error		      tries = tries + 1		      if (tries <= App.kConnectionRetries) then		        showMessage(kErrorDownloadingManifest, Array(str(tries)))		        sockManifest.Get(App.kRepositoryURL + "/manifest.xml")		      else		        showMessage(kGivingUp)		        prgBar.visible = false		        exit		      end if		    else		      // Socket exited cleanly		      exit		    end if		  loop		End Sub	#tag EndEvent#tag EndEvents#tag Events btnSaveManifest	#tag Event		Sub Action()		  dim manifestFolderItem as FolderItem = new FolderItem()		  manifestFolderItem = manifestFolderItem.child("manifest.xml")		  		  pLocalManifest.save(manifestFolderItem)		End Sub	#tag EndEvent#tag EndEvents#tag Events sockManifest	#tag Event		Sub PageReceived(url as string, httpStatus as integer, headers as internetHeaders, content as string)		  prgBar.visible = false		  txtProgress.visible = false		  		  if pServerManifest.gatherManifestFromXMLString(content) then		    showMessage(kManifestDownloaded)		    thrCheckFolderStructure.run		  else		    showMessage(kErrorManifest)		  end if		  		End Sub	#tag EndEvent	#tag Event		Sub ReceiveProgress(bytesReceived as integer, totalBytes as integer, newData as string)		  prgBar.maximum = totalBytes		  prgBar.value = bytesReceived		End Sub	#tag EndEvent#tag EndEvents#tag Events thrCheckFolderStructure	#tag Event		Sub Run()		  dim i as Integer		  		  prgBar.visible = true		  prgBar.maximum = 0		  txtProgress.visible = false		  		  pPendingFiles = new Collection()		  pDeletedFiles = new Collection()		  		  pLocalManifest.getDifferences(pServerManifest, pPendingFiles, pDeletedFiles)		  		  if (pPendingFiles.count = 0 and pDeletedFiles.count = 0) then		    showMessage(kInstallUpToDate)		  else		    showMessage(kInstallOutOfDate, Array(str(pDeletedFiles.count), str(pPendingFiles.count)))		    btnBegin.enabled = true		  end if		  		  showMessage(kSeparator)		  prgBar.visible = false		  btnSetXPlaneFolder.enabled = true		End Sub	#tag EndEvent#tag EndEvents#tag Events sockFile	#tag Event		Sub ReceiveProgress(bytesReceived as integer, totalBytes as integer, newData as string)		  prgBar.maximum = totalBytes		  prgBar.value = bytesReceived		End Sub	#tag EndEvent	#tag Event		Sub DownloadComplete(url as string, httpStatus as integer, headers as internetHeaders, file as folderItem)		  if (httpStatus = 200) then		    dim filePath as String = pPendingFiles.item(1)		    dim zar as ZipArchive = new ZipArchive		    dim f as FolderItem, e as ZipEntry, i as Integer		    		    pPendingFiles.remove(1)		    		    dim destinationFolderItem as FolderItem = pLocalManifest.getLocalFolderItem(filePath)		    if (destinationFolderItem.exists) then destinationFolderItem.delete()		    		    if not zar.Open(file, false) then		      showMessage(kError, Array(zar.ErrorMessage))		      return		    end		    		    e = zar.Entry(1)		    f = e.MakeDestination(new FolderItem(), false)		    		    if not e.Extract(f) then		      showMessage(kExtractionFailed, Array(e.RawPath, e.ErrorMessage))		      return		    end		    		    if not zar.Close() then		      showMessage(kError, Array(zar.ErrorMessage))		      return		    end		    		    f.moveFileTo(destinationFolderItem)		    file.delete()		    		    downloadNextFile()		    		  else		    showMessage(kErrorHTTP, Array(str(httpStatus)))		    prgBar.visible = false		    txtProgress.visible = false		  end if		End Sub	#tag EndEvent	#tag Event		Sub Error(code as integer)		  showMessage(kErrorDownloading, Array(str(code)))		  downloadNextFile()		End Sub	#tag EndEvent#tag EndEvents#tag Events btnSetXPlaneFolder	#tag Event		Sub Action()		  if (App.getXPlaneFolder(false)) then		    btnSetXPlaneFolder.enabled = false		    btnBegin.enabled = false		    setupOSXFolder()		    displayXPlaneFolder()		    checkOSXFolder()		  end if		End Sub	#tag EndEvent#tag EndEvents#tag Events btnBegin	#tag Event		Sub Action()		  btnBegin.enabled = false		  btnSetXPlaneFolder.enabled = false		  thrUpdateFolderStructure.run()		  		End Sub	#tag EndEvent#tag EndEvents#tag Events thrUpdateFolderStructure	#tag Event		Sub Run()		  dim i as Integer		  		  prgBar.visible = true		  prgBar.maximum = 0		  		  if (pDeletedFiles.count > 0) then		    showMessage(endofline + kDeletingFiles)		    for i = 1 to pDeletedFiles.count		      showMessage(pDeletedFiles.item(i))		      pLocalManifest.getLocalFolderItem(pDeletedFiles.item(i)).delete		    next		  end if		  		  showMessage(kDownloadingChangedFiles)		  downloadNextFile()		  		End Sub	#tag EndEvent#tag EndEvents