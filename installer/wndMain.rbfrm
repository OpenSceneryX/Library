#tag WindowBegin Window wndMain   BackColor       =   16777215   Backdrop        =   ""   BalloonHelp     =   ""   CloseButton     =   "True"   Composite       =   "False"   Frame           =   0   FullScreen      =   "False"   HasBackColor    =   "False"   Height          =   482   LiveResize      =   "True"   MacProcID       =   0   MaxHeight       =   32000   MaximizeButton  =   "False"   MaxWidth        =   32000   MenuBar         =   341440760   MenuBarVisible  =   "True"   MinHeight       =   482   MinimizeButton  =   "True"   MinWidth        =   453   Placement       =   0   Resizeable      =   "True"   Title           =   "OpenSceneryX Installer"   Visible         =   "True"   Width           =   453   Begin Canvas Canvas1      AcceptFocus     =   ""      AcceptTabs      =   ""      AutoDeactivate  =   "True"      Backdrop        =   200112520      ControlOrder    =   0      Enabled         =   True      EraseBackground =   "True"      Height          =   52      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Left            =   20      LockBottom      =   ""      LockLeft        =   ""      LockRight       =   ""      LockTop         =   ""      TabPanelIndex   =   0      Top             =   14      UseFocusRing    =   "True"      Visible         =   True      Width           =   236      BehaviorIndex   =   0   End   Begin Thread thrBuildLocalManifest      ControlOrder    =   1      Index           =   -2147483648      InitialParent   =   ""      Left            =   20      Priority        =   4      StackSize       =   0      TabPanelIndex   =   0      Top             =   -65      BehaviorIndex   =   1   End   Begin PushButton btnSaveManifest      AutoDeactivate  =   "True"      Bold            =   ""      Cancel          =   ""      Caption         =   "Save Manifest"      ControlOrder    =   2      Default         =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   503      LockBottom      =   ""      LockLeft        =   ""      LockRight       =   ""      LockTop         =   ""      TabPanelIndex   =   0      TextFont        =   "System"      TextSize        =   0      Top             =   -53      Underline       =   ""      Visible         =   True      Width           =   108      BehaviorIndex   =   2   End   Begin Thread thrLoadServerManifest      ControlOrder    =   3      Index           =   -2147483648      InitialParent   =   ""      Left            =   64      Priority        =   4      StackSize       =   0      TabPanelIndex   =   0      Top             =   -65      BehaviorIndex   =   3   End   Begin HTTPSocket sockManifest      Address         =   ""      ControlOrder    =   4      Index           =   -2147483648      InitialParent   =   ""      Left            =   374      Port            =   80      TabPanelIndex   =   0      Top             =   -65      yield           =   0      BehaviorIndex   =   4   End   Begin Thread thrCheckFolderStructure      ControlOrder    =   5      Index           =   -2147483648      InitialParent   =   ""      Left            =   108      Priority        =   4      StackSize       =   0      TabPanelIndex   =   0      Top             =   -65      BehaviorIndex   =   5   End   Begin EditField fldMessage      AcceptTabs      =   ""      Alignment       =   0      AutoDeactivate  =   "True"      BackColor       =   &hFFFFFF      Bold            =   ""      Border          =   "True"      ControlOrder    =   6      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Format          =   ""      Height          =   320      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   20      LimitText       =   0      LockBottom      =   "True"      LockLeft        =   "True"      LockRight       =   "True"      LockTop         =   "True"      Mask            =   ""      Multiline       =   "True"      Password        =   ""      ReadOnly        =   "True"      ScrollbarHorizontal=   ""      ScrollbarVertical=   "True"      Styled          =   ""      TabPanelIndex   =   0      Text            =   ""      TextColor       =   &h000000      TextFont        =   "System"      TextSize        =   10      Top             =   110      Underline       =   ""      UseFocusRing    =   "True"      Visible         =   True      Width           =   413      BehaviorIndex   =   6   End   Begin ProgressBar prgBar      AutoDeactivate  =   "True"      ControlOrder    =   7      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Left            =   108      LockBottom      =   "True"      LockLeft        =   "True"      LockRight       =   "True"      LockTop         =   "False"      Maximum         =   100      TabPanelIndex   =   0      Top             =   442      Value           =   0      Visible         =   "False"      Width           =   325      BehaviorIndex   =   7   End   Begin HTTPSocket sockFile      Address         =   ""      ControlOrder    =   8      Index           =   -2147483648      InitialParent   =   ""      Left            =   413      Port            =   80      TabPanelIndex   =   0      Top             =   -65      yield           =   0      BehaviorIndex   =   8   End   Begin StaticText StaticText1      AutoDeactivate  =   "True"      Bold            =   "True"      ControlOrder    =   9      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   20      LockBottom      =   ""      LockLeft        =   ""      LockRight       =   ""      LockTop         =   ""      Multiline       =   ""      TabPanelIndex   =   0      Text            =   "X-Plane Folder:"      TextAlign       =   0      TextColor       =   &h000000      TextFont        =   "System"      TextSize        =   10      Top             =   78      Underline       =   ""      Visible         =   True      Width           =   89      BehaviorIndex   =   9   End   Begin StaticText txtXplaneFolder      AutoDeactivate  =   "True"      Bold            =   ""      ControlOrder    =   10      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   121      LockBottom      =   ""      LockLeft        =   "True"      LockRight       =   "True"      LockTop         =   ""      Multiline       =   ""      TabPanelIndex   =   0      Text            =   "Untitled"      TextAlign       =   0      TextColor       =   &h000000      TextFont        =   "System"      TextSize        =   10      Top             =   78      Underline       =   ""      Visible         =   True      Width           =   265      BehaviorIndex   =   10   End   Begin PushButton btnSetXPlaneFolder      AutoDeactivate  =   "True"      Bold            =   ""      Cancel          =   ""      Caption         =   "Setâ€¦"      ControlOrder    =   11      Default         =   ""      Enabled         =   "False"      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   386      LockBottom      =   ""      LockLeft        =   ""      LockRight       =   "True"      LockTop         =   ""      TabPanelIndex   =   0      TextFont        =   "System"      TextSize        =   10      Top             =   77      Underline       =   ""      Visible         =   True      Width           =   47      BehaviorIndex   =   11   End   Begin PushButton btnBegin      AutoDeactivate  =   "True"      Bold            =   ""      Cancel          =   ""      Caption         =   "Go"      ControlOrder    =   12      Default         =   ""      Enabled         =   "False"      Height          =   51      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   353      LockBottom      =   ""      LockLeft        =   ""      LockRight       =   "True"      LockTop         =   ""      TabPanelIndex   =   0      TextFont        =   "System"      TextSize        =   0      Top             =   14      Underline       =   ""      Visible         =   True      Width           =   80      BehaviorIndex   =   12   End   Begin Thread thrUpdateFolderStructure      ControlOrder    =   13      Index           =   -2147483648      InitialParent   =   ""      Left            =   152      Priority        =   4      StackSize       =   0      TabPanelIndex   =   0      Top             =   -65      BehaviorIndex   =   13   End   Begin StaticText txtProgress      AutoDeactivate  =   "True"      Bold            =   ""      ControlOrder    =   14      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   20      LockBottom      =   "True"      LockLeft        =   "True"      LockRight       =   ""      LockTop         =   ""      Multiline       =   ""      TabPanelIndex   =   0      Text            =   "Untitled"      TextAlign       =   0      TextColor       =   &h000000      TextFont        =   "System"      TextSize        =   10      Top             =   442      Underline       =   ""      Visible         =   True      Width           =   74      BehaviorIndex   =   14   EndEnd#tag EndWindow#tag WindowCode	#tag Event		Sub Open()		  setupOSXFolder()		  displayXPlaneFolder()		  checkOSXFolder()		End Sub	#tag EndEvent	#tag Method, Flags = &h0		Sub downloadNextFile()		  if (pPendingFiles.Count > 0) then		    dim filePath as String = normaliseFilePath(pPendingFiles.item(1))		    dim destinationFolderItem as FolderItem = new FolderItem()		    dim i as Integer		    dim parts() as String = filePath.split("/")		    		    txtProgress.visible = true		    txtProgress.text = str(pPendingFiles.count) + " remaining"		    destinationFolderItem = destinationFolderItem.child("temp")		    showMessage(filePath)		    		    dim url as string = "www.opensceneryx.com/repository"		    		    for i = 0 to ubound(parts)		      if (parts(i) <> "") then url = url + "/"		      url = url + encodeURLComponent(parts(i))		    next		    		    url = url + ".zip"		    'showMessage(url)		    		    sockFile.get(url, destinationFolderItem)		  else		    showMessage("Your OpenSceneryX installation is now Complete.")		    prgBar.visible = false		    txtProgress.visible = false		    btnSetXPlaneFolder.enabled = true		  end if		  		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub showMessage(message as String)		  fldMessage.appendText(message + endOfLine)		  fldMessage.scrollPosition = 10000000		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub setupOSXFolder()		  dim foundPrevious as boolean = false		  dim tempFolderItem as FolderItem		  		  // Newest name takes top priority, followed by older releases		  pOsxFolderItem = App.pXPlaneFolder.child("Custom Scenery").child("OpenSceneryX")		  if (pOsxFolderItem.exists()) then		    foundPrevious = true		  end if		  		  tempFolderItem = App.pXPlaneFolder.child("Custom Scenery").child("OpenSceneryX-1.1.0")		  if (tempFolderItem.exists) then		    if (foundPrevious) then		      Utilities.deleteContentsOfFolder(tempFolderItem)		      tempFolderItem.delete()		    else		      tempFolderItem.moveFileTo(pOsxFolderItem)		      foundPrevious = true		    end if		  end if		  		  tempFolderItem = App.pXPlaneFolder.child("Custom Scenery").child("OpenSceneryX-1.0.0")		  if (tempFolderItem.exists) then		    if (foundPrevious) then		      Utilities.deleteContentsOfFolder(tempFolderItem)		      tempFolderItem.delete()		    else		      tempFolderItem.moveFileTo(pOsxFolderItem)		      foundPrevious = true		    end if		  end if		  		  if (not foundPrevious) then		    pOsxFolderItem.createAsFolder()		  end if		  		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub displayXPlaneFolder()		  txtXplaneFolder.text = App.pXPlaneFolder.absolutePath		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub checkOSXFolder()		  pLocalManifest = new FolderManifest()		  pServerManifest = new FolderManifest()		  		  thrBuildLocalManifest.run()		End Sub	#tag EndMethod	#tag Property, Flags = &h0		pOsxFolderItem As FolderItem	#tag EndProperty	#tag Property, Flags = &h0		pLocalManifest As FolderManifest	#tag EndProperty	#tag Property, Flags = &h0		pServerManifest As FolderManifest	#tag EndProperty	#tag Property, Flags = &h0		pPendingFiles As Collection	#tag EndProperty	#tag Property, Flags = &h0		pDeletedFiles As Collection	#tag EndProperty#tag EndWindowCode#tag Events thrBuildLocalManifest	#tag Event		Sub Run()		  prgBar.visible = true		  prgBar.maximum = 0		  txtProgress.visible = false		  		  showMessage("Collecting local file information...")		  pLocalManifest.gatherManifestFromLocalFolderItem(pOsxFolderItem)		  showMessage("Complete.")		  showMessage("----")		  		  prgBar.visible = false		  		  thrLoadServerManifest.run		End Sub	#tag EndEvent#tag EndEvents#tag Events btnSaveManifest	#tag Event		Sub Action()		  dim manifestFolderItem as FolderItem = new FolderItem()		  manifestFolderItem = manifestFolderItem.child("manifest.xml")		  		  pLocalManifest.save(manifestFolderItem)		End Sub	#tag EndEvent#tag EndEvents#tag Events thrLoadServerManifest	#tag Event		Sub Run()		  prgBar.visible = true		  txtProgress.visible = false		  		  showMessage("Connecting to the server and loading the list of available files, please wait...")		  		  sockManifest.Get("www.opensceneryx.com/manifest.xml")		  		End Sub	#tag EndEvent#tag EndEvents#tag Events sockManifest	#tag Event		Sub PageReceived(url as string, httpStatus as integer, headers as internetHeaders, content as string)		  prgBar.visible = false		  txtProgress.visible = false		  		  if pServerManifest.gatherManifestFromXMLString(content) then		    showMessage("The download of the list of files is complete.")		    thrCheckFolderStructure.run		  else		    showMessage("There was a problem reading from the server, please try again later.")		  end if		  		End Sub	#tag EndEvent	#tag Event		Sub ReceiveProgress(bytesReceived as integer, totalBytes as integer, newData as string)		  prgBar.maximum = totalBytes		  prgBar.value = bytesReceived		End Sub	#tag EndEvent#tag EndEvents#tag Events thrCheckFolderStructure	#tag Event		Sub Run()		  dim i as Integer		  		  prgBar.visible = true		  prgBar.maximum = 0		  txtProgress.visible = false		  		  pPendingFiles = new Collection()		  pDeletedFiles = new Collection()		  		  pLocalManifest.getDifferences(pServerManifest, pPendingFiles, pDeletedFiles)		  		  if (pPendingFiles.count = 0 and pDeletedFiles.count = 0) then		    showMessage("Your OpenScenery install is completely up to date, you may now quit this installer.")		  elseif 		    showMessage("Your OpenScenery install is out of date, " + str(pDeletedFiles.count) + " files need to be deleted and " + str(pPendingFiles.count) + " files need to be downloaded, press the 'Go' button to begin the process.")		    btnBegin.enabled = true		  end if		  		  showMessage("----")		  prgBar.visible = false		  btnSetXPlaneFolder.enabled = true		End Sub	#tag EndEvent#tag EndEvents#tag Events sockFile	#tag Event		Sub ReceiveProgress(bytesReceived as integer, totalBytes as integer, newData as string)		  prgBar.maximum = totalBytes		  prgBar.value = bytesReceived		End Sub	#tag EndEvent	#tag Event		Sub DownloadComplete(url as string, httpStatus as integer, headers as internetHeaders, file as folderItem)		  if (httpStatus = 200) then		    dim filePath as String = pPendingFiles.item(1)		    dim zar as ZipArchive = new ZipArchive		    dim f as FolderItem, e as ZipEntry, i as Integer		    		    pPendingFiles.remove(1)		    		    dim destinationFolderItem as FolderItem = pLocalManifest.getLocalFolderItem(filePath)		    if (destinationFolderItem.exists) then destinationFolderItem.delete()		    		    if not zar.Open(file, false) then		      showMessage("Error: " + zar.ErrorMessage)		      return		    end		    		    e = zar.Entry(1)		    f = e.MakeDestination(new FolderItem(), false)		    		    if not e.Extract(f) then		      showMessage("Extraction of """+e.RawPath+""" failed: "+e.ErrorMessage)		      return		    end		    		    if not zar.Close() then		      showMessage("Error: " + zar.ErrorMessage)		      return		    end		    		    f.moveFileTo(destinationFolderItem)		    		    downloadNextFile()		  else		    showMessage("There was an error downloading the file (status " + str(httpStatus) + "), the download was aborted.")		    prgBar.visible = false		    txtProgress.visible = false		  end if		End Sub	#tag EndEvent#tag EndEvents#tag Events btnSetXPlaneFolder	#tag Event		Sub Action()		  if (App.getXPlaneFolder(false)) then		    btnSetXPlaneFolder.enabled = false		    btnBegin.enabled = false		    setupOSXFolder()		    displayXPlaneFolder()		    checkOSXFolder()		  end if		End Sub	#tag EndEvent#tag EndEvents#tag Events btnBegin	#tag Event		Sub Action()		  btnBegin.enabled = false		  btnSetXPlaneFolder.enabled = false		  thrUpdateFolderStructure.run()		  		End Sub	#tag EndEvent#tag EndEvents#tag Events thrUpdateFolderStructure	#tag Event		Sub Run()		  dim i as Integer		  		  prgBar.visible = true		  prgBar.maximum = 0		  		  if (pDeletedFiles.count > 0) then		    showMessage(endofline + "Deleting Files:")		    for i = 1 to pDeletedFiles.count		      showMessage(pDeletedFiles.item(i))		      pLocalManifest.getLocalFolderItem(pDeletedFiles.item(i)).delete		    next		  end if		  		  showMessage("Downloading Changed Files:")		  downloadNextFile()		  		End Sub	#tag EndEvent#tag EndEvents